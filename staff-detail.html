<!-- 
   ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£†‚£§‚£§‚£¥‚£∂‚£∂‚£∂‚£∂‚£§‚£§‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
   ‚ö† HACKER WARNING ‚ö†

   H·ª°i ng∆∞·ªùi b·∫°n coder b√≠ ·∫©n n√†o ƒëang inspect file n√†y...
   ...h√£y hi·ªÉu r·∫±ng ƒë·∫øn ch√≠nh t√¥i c√≤n ch·∫≥ng bi·∫øt n√≥ ho·∫°t ƒë·ªông ki·ªÉu g√¨ ü´†

   ‚úî D·ªØ li·ªáu ƒë√£ qua filter & validation ·ªü server
   ‚úî Kh√¥ng c√≥ d·ªØ li·ªáu nh·∫°y c·∫£m trong client-side
   ‚úî M·ªôt s·ªë h√†nh vi ph·ªï bi·∫øn ƒë√£ b·ªã ch·∫∑n (XSS, SqlInjection, clickjacking v.v)
   ‚úî N·ªôi dung ƒë∆∞·ª£c t·∫£i t·ª´ SonicJS ‚Üí client render qua Alpine.js
   ‚úî API ch·∫°y sau Cloudflare, c√≥ log to√†n b·ªô IP l·∫°
   ‚úî Ddos ƒë√£ ƒë∆∞·ª£c b·∫£o v·ªá b·∫±ng Cloudflare
   ‚úî Kh√¥ng c√≥ th√¥ng tin nh·∫°y c·∫£m trong source code

   üí° N·∫øu b·∫°n t√¨m th·∫•y l·ªó h·ªïng m√† t√¥i ch∆∞a ph√°t hi·ªán, h√£y g·ª≠i t√¥i m·ªôt c√°i CV
   ‚úåÔ∏è Peace, v√† ch√∫c b·∫°n ƒë·ªçc source code n√†y kh√¥ng b·ªã t·ªïn th∆∞∆°ng t√¢m l√Ω

   --- SYSTEM OVERVIEW ---
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Client UI   ‚îÇ ‚Üê‚îÄ‚îÄ‚îÄ HTML + Alpine.js
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ fetch
           ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ SonicJS API   ‚îÇ ‚Üê‚îÄ‚îÄ Cloudflare D1 (DB) + R2 (images/files)
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚ñ≤
        Cloudflare Worker / Proxy (optional)

-->
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt th√†nh vi√™n</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="./public/output.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ·∫®n thanh cu·ªôn nh∆∞ng v·∫´n gi·ªØ cu·ªôn */
        .scrollable-info {
            overflow-y: scroll;
            /* Cho ph√©p cu·ªôn theo chi·ªÅu d·ªçc */
            scrollbar-width: thin;
            /* Tr√™n Firefox: thanh cu·ªôn m·∫£nh */
            scrollbar-color: transparent transparent;
            /* Tr√™n Firefox: ·∫©n m√†u c·ªßa thanh cu·ªôn */
        }

        /* ·∫®n thanh cu·ªôn tr√™n c√°c tr√¨nh duy·ªát Webkit (Chrome, Safari) */
        .scrollable-info::-webkit-scrollbar {
            display: none;
            /* ·∫®n thanh cu·ªôn */
        }

        /* fix */
        html,
        body {
            overflow-x: hidden;
        }
    </style>
</head>

<body class="bg-white text-zinc-800 overflow-x-hidden" x-data="employeeDetailApp()" x-init="init()">

    <div x-show="loading.employee || loading.initialData"
        class="min-h-[calc(100vh-68px)] flex flex-col items-center justify-center text-gray-500 fixed inset-0 bg-white/50 backdrop-blur-sm z-50"
        x-cloak>
        <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
        <p class="mt-3 text-lg">ƒêang t·∫£i d·ªØ li·ªáu th√†nh vi√™n...</p>
    </div>

    <div x-show="!loading.employee && apiError"
        class="min-h-[calc(100vh-68px)] flex flex-col items-center justify-center text-red-500 px-6 text-center fixed inset-0 bg-white/50 backdrop-blur-sm z-50"
        x-cloak>
        <i class="fas fa-exclamation-triangle text-5xl mb-4"></i>
        <h2 class="text-2xl font-semibold mb-2">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin</h2>
        <p x-text="apiError"></p>
        <button @click="fetchEmployeeData(true)"
            class="mt-4 px-3 py-1.5 bg-red-500 text-white rounded hover:bg-red-600">Th·ª≠ l·∫°i</button>
        <a href="/staff" class="mt-3 text-blue-600 hover:underline">Quay l·∫°i trang danh s√°ch</a>
    </div>

    <template x-if="!loading.employee && employee && !apiError">
        <section
            class="w-full min-h-screen px-6 py-16 md:py-24 bg-gradient-to-b from-purple-100 via-pink-100 to-violet-200">
            <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-12 items-start">

                <div
                    class="relative w-full flex items-center justify-center md:sticky md:top-[calc(var(--header-height,68px)+1.5rem)]">
                    <div
                        class="w-72 h-72 md:w-[400px] md:h-[400px] overflow-hidden relative avatar-container rounded-xl shadow-xl">
                        <img :src="employee.avatarInProfile || 'https://via.placeholder.com/600x600?text=No+Avatar'"
                            :alt="employee.nickname" class="w-full h-full object-cover clip-avatar rounded-xl" />
                    </div>
                </div>

                <div class="space-y-6 md:scrollable-info md:pr-2 md:pb-16">
                    <div class="space-y-2">
                        <h1 class="text-4xl font-bold text-zinc-900" x-text="employee.nickname"></h1>
                        <h2 class="text-lg font-medium text-indigo-600"
                            x-text="employee.responsibilities || 'Ch∆∞a c·∫≠p nh·∫≠t'"></h2>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-zinc-600">
                        <div>
                            <span class="block text-zinc-500">Ng√†y sinh</span>
                            <span class="font-medium text-emerald-600"
                                x-text="employee.birthday ? employee.birthday : 'Ch∆∞a c·∫≠p nh·∫≠t'"></span>
                        </div>
                        <div>
                            <span class="block text-zinc-500">Tham gia t·ª´</span>
                            <span class="font-medium text-cyan-600"
                                x-text="employee.joinYear ? employee.joinYear : 'Ch∆∞a c·∫≠p nh·∫≠t'"></span>
                        </div>
                        <div class="sm:col-span-2" x-show="employee.catchphrase">
                            <span class="block text-zinc-500">Catchphrase</span>
                            <span class="italic text-violet-700 font-semibold" x-text="employee.catchphrase"></span>
                        </div>
                        <div class="sm:col-span-2" x-show="employee.trueCategoryId">
                            <span class="block text-zinc-500">Nh√≥m</span>
                            <span class="font-medium text-purple-600 capitalize"
                                x-text="getCategoryNameByTrueId(employee.trueCategoryId)"></span>
                        </div>
                        <div class="sm:col-span-2"
                            x-show="employee.fullBadgesData && employee.fullBadgesData.length > 0">
                            <span class="block text-zinc-500 pb-1">Huy hi·ªáu</span>
                            <div class="flex flex-wrap gap-2">
                                <template x-for="badge in employee.fullBadgesData" :key="badge.id || badge.name">
                                    <div class="relative group">
                                        <span
                                            class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs sm:text-sm shadow-sm cursor-pointer"
                                            :class="[getBadgeTailwindClasses(badge.color).bg, getBadgeTailwindClasses(badge.color).text]">
                                            <span x-text="badge.emoji ? badge.emoji : ''" class="text-sm"></span>
                                            <p class="whitespace-nowrap ml-0.5" x-text="badge.name"></p>
                                        </span>
                                        <div x-show="badge.description"
                                            class="absolute z-20 left-1/2 -translate-x-1/2 mt-2 w-max max-w-xs bg-white border border-gray-200 rounded-lg shadow-lg px-3 py-2 text-xs text-gray-700 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200"
                                            x-text="badge.description">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Ph·∫ßn description -->
                    <div class="text-base leading-relaxed text-zinc-700 border-l-4 border-pink-400 pl-4 pr-4 py-3 bg-pink-50 rounded-l-md"
                        x-show="employee.description" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform -translate-x-2"
                        x-transition:enter-end="opacity-100 transform translate-x-0"
                        x-transition:leave="transition ease-in duration-200"
                        x-transition:leave-start="opacity-100 transform translate-x-0"
                        x-transition:leave-end="opacity-0 transform -translate-x-2">
                        <p class="m-0" x-html="employee.description"></p>
                    </div>

                    <!-- Ph·∫ßn hobbies -->
                    <div class="text-base leading-relaxed text-zinc-700 border-l-4 border-green-400 pl-4 pr-4 py-3 bg-pink-50 rounded-l-md mt-4"
                        x-show="employee.hobbies" x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform -translate-x-2"
                        x-transition:enter-end="opacity-100 transform translate-x-0"
                        x-transition:leave="transition ease-in duration-200"
                        x-transition:leave-start="opacity-100 transform translate-x-0"
                        x-transition:leave-end="opacity-0 transform -translate-x-2">
                        <span class="block text-zinc-500 text-sm font-semibold pb-1">S·ªü th√≠ch</span>
                        <p class="m-0" x-html="employee.hobbies"></p>
                    </div>



                    <div class="flex flex-col items-center justify-center py-4">
                        <div class="flex flex-row flex-wrap justify-center gap-3 pt-2">
                            <template x-for="link in [
            { key: 'facebook', icon: 'fab fa-facebook', label: 'Facebook', color: 'text-blue-600' },
            { key: 'twitter', icon: 'fab fa-twitter', label: 'Twitter', color: 'text-sky-500' },
            { key: 'pixiv', icon: 'fa-solid fa-palette', label: 'Pixiv', color: 'text-pink-500' }
        ]" :key="link.key">
                                <a :href="employee[link.key] || '#'" target="_blank" :title="link.label" :class="[
                    'group flex items-center justify-center w-11 h-11 rounded-full shadow border transition-all duration-150',
                    employee[link.key] ? 'bg-white hover:scale-110 hover:bg-emerald-50 border-gray-200 cursor-pointer' : 'bg-gray-100 opacity-40 pointer-events-none border-gray-300 cursor-default',
                    link.color
                ]">
                                    <i :class="link.icon + ' text-2xl'"></i>
                                    <span class="sr-only" x-text="link.label"></span>
                                </a>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <script>
        const API_BASE_URL = 'https://api.worldsimp.com/api/v1';

        function employeeDetailApp() {
            return {
                employeeIdentifier: null,
                employee: null,
                categories: [],
                allBadges: [],
                loading: {
                    initialData: true,
                    employee: true
                },
                apiError: null,

                async init() {
                    console.log("Alpine Detail Page: Initializing...");
                    const pathParts = window.location.pathname.toLowerCase().split('/').filter(Boolean);

                    if (pathParts.length === 2 && pathParts[0] === 'staff') {
                        this.employeeIdentifier = decodeURIComponent(pathParts[1]);
                    } else {
                        // Fallback n·∫øu URL kh√¥ng ƒë√∫ng d·∫°ng /staff/nickname, th·ª≠ t√¨m query param (d√π _redirects ƒë√£ x·ª≠ l√Ω path)
                        const urlParams = new URLSearchParams(window.location.search);
                        this.employeeIdentifier = urlParams.get('nickname');
                    }

                    if (!this.employeeIdentifier) {
                        this.apiError = "Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·ªãnh danh (nickname) th√†nh vi√™n trong URL.";
                        this.loading.initialData = false;
                        this.loading.employee = false;
                        document.title = "L·ªói - Kh√¥ng t√¨m th·∫•y th√†nh vi√™n";
                        console.error("Alpine Detail Page:", this.apiError);
                        return;
                    }
                    document.title = `ƒêang t·∫£i... ${this.employeeIdentifier}`;

                    try {
                        // T·∫£i categories v√† badges song song
                        const dataPromises = [this.loadCategories(), this.loadAllBadges()];
                        const results = await Promise.allSettled(dataPromises);
                        results.forEach((result, index) => {
                            if (result.status === 'rejected') {
                                const type = index === 0 ? 'categories' : 'badges';
                                this.apiError = this.apiError || `L·ªói t·∫£i ${type}: ${result.reason.message}`;
                            }
                        });
                    } finally {
                        this.loading.initialData = false;
                    }

                    if (this.apiError) { // N·∫øu l·ªói t·∫£i categories/badges, c√≥ th·ªÉ v·∫´n th·ª≠ t·∫£i employee nh∆∞ng b√°o l·ªói
                        console.warn("Alpine Detail Page: Error loading categories/badges, proceeding to fetch employee data but some info might be missing.");
                        // Kh√¥ng return ·ªü ƒë√¢y, v·∫´n th·ª≠ fetch employee
                    }
                    await this.fetchEmployeeData();
                },

                async loadData(propertyKey, url, typeName) {
                    console.log(`Alpine Detail Page: Loading ${typeName}...`);
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`${typeName} API Error: ${response.status}`);
                        const data = await response.json();
                        this[propertyKey] = data || [];
                        console.log(`Alpine Detail Page: ${typeName} loaded`, this[propertyKey].length);
                    } catch (error) {
                        console.error(`Alpine Detail Page: Error loading ${typeName}:`, error);
                        this.apiError = this.apiError || error.message; // Gi·ªØ l·ªói ƒë·∫ßu ti√™n
                        this[propertyKey] = [];
                    }
                },
                async loadCategories() { await this.loadData('categories', `${API_BASE_URL}/categories`, 'Categories'); },
                async loadAllBadges() { await this.loadData('allBadges', `${API_BASE_URL}/badges`, 'Badges'); },

                async fetchEmployeeData(isRetry = false) {
                    if (!isRetry) {
                        console.log("Alpine Detail Page: Fetching employee data for nickname:", this.employeeIdentifier);
                        this.loading.employee = true;
                    }
                    this.apiError = null; // Reset l·ªói c·ª• th·ªÉ c·ªßa employee fetch
                    try {
                        const response = await fetch(`${API_BASE_URL}/employees?range=[0,999]`);
                        if (!response.ok) throw new Error(`Employees API Error: ${response.status}`);
                        const data = await response.json();
                        const allEmployeesRaw = data || [];

                        let foundEmployee = allEmployeesRaw.find(emp =>
                            emp.nickname && emp.nickname.toLowerCase() === this.employeeIdentifier.toLowerCase()
                        );

                        if (foundEmployee) {
                            const categoryObject = this.categories.find(
                                cat => cat.title && foundEmployee.category && cat.title.toLowerCase() === foundEmployee.category.toLowerCase()
                            );
                            foundEmployee.trueCategoryId = categoryObject ? categoryObject.id : null;

                            if (foundEmployee.badges && typeof foundEmployee.badges === 'string') {
                                const badgeNamesOrIds = foundEmployee.badges.split(',').map(b => b.trim());
                                foundEmployee.fullBadgesData = badgeNamesOrIds.map(nameOrId => {
                                    const badgeInfo = this.allBadges.find(b => b.id === nameOrId || (b.name && b.name.toLowerCase() === nameOrId.toLowerCase()));
                                    return badgeInfo ? badgeInfo : { name: nameOrId.trim(), color: '#D1D5DB', emoji: '‚ùî', id: `unknown-badge-${nameOrId}` };
                                }).filter(b => b && b.name);
                            } else {
                                foundEmployee.fullBadgesData = [];
                            }
                            this.employee = foundEmployee;
                            document.title = `Chi ti·∫øt: ${this.employee.nickname}`;
                        } else {
                            this.apiError = `Kh√¥ng t√¨m th·∫•y th√†nh vi√™n v·ªõi nickname: "${this.employeeIdentifier}"`;
                            document.title = "Kh√¥ng t√¨m th·∫•y th√†nh vi√™n";
                        }
                    } catch (error) {
                        console.error('Alpine Detail Page: Error fetching employee data:', error);
                        this.apiError = error.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi t·∫£i d·ªØ li·ªáu th√†nh vi√™n.";
                        document.title = "L·ªói t·∫£i d·ªØ li·ªáu";
                    } finally {
                        this.loading.employee = false;
                    }
                },

                getCategoryNameByTrueId(trueCategoryId) {
                    if (!trueCategoryId) return 'Ch∆∞a ph√¢n lo·∫°i';
                    if (this.loading.initialData && this.categories.length === 0 && !this.apiError) return 'ƒêang x·ª≠ l√Ω...';
                    if (this.apiError && this.categories.length === 0) return 'L·ªói category';
                    const category = this.categories.find(cat => cat.id === trueCategoryId);
                    return category ? category.title : 'Kh√¥ng x√°c ƒë·ªãnh';
                },

                getContrastingTextColor(hexColor) {
                    if (!hexColor) return '#1f2937';
                    let color = hexColor.startsWith('#') ? hexColor.slice(1) : hexColor;
                    if (color.length === 3) color = color.split('').map(char => char + char).join('');
                    if (color.length !== 6) return '#1f2937';
                    const r = parseInt(color.substring(0, 2), 16);
                    const g = parseInt(color.substring(2, 4), 16);
                    const b = parseInt(color.substring(4, 6), 16);
                    const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                    return (yiq >= 135) ? '#111827' : '#FFFFFF';
                },
                getBadgeTailwindClasses(apiColorName) {
                    if (!apiColorName) { // M√†u m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ ho·∫∑c kh√¥ng kh·ªõp
                        return { bg: 'bg-gray-100', text: 'text-gray-700' };
                    }
                    // √Ånh x·∫° t√™n m√†u t·ª´ API sang c√°c c·∫∑p class Tailwind
                    // B·∫°n c·∫ßn b·ªï sung c√°c m√†u kh√°c t·ª´ API badges c·ªßa b·∫°n v√†o ƒë√¢y
                    const colorMap = {
                        'red': { bg: 'bg-red-100', text: 'text-red-700' },
                        'blue': { bg: 'bg-blue-100', text: 'text-blue-700' },
                        'green': { bg: 'bg-green-100', text: 'text-green-700' },
                        'yellow': { bg: 'bg-yellow-100', text: 'text-yellow-800' }, // Yellow text th∆∞·ªùng c·∫ßn ƒë·∫≠m h∆°n
                        'indigo': { bg: 'bg-indigo-100', text: 'text-indigo-700' },
                        'purple': { bg: 'bg-purple-100', text: 'text-purple-700' },
                        'pink': { bg: 'bg-pink-100', text: 'text-pink-700' },
                        'gray': { bg: 'bg-gray-100', text: 'text-gray-700' },
                        'emerald': { bg: 'bg-emerald-100', text: 'text-emerald-700' },
                        'rose': { bg: 'bg-rose-100', text: 'text-rose-700' },
                        'amber': { bg: 'bg-amber-100', text: 'text-amber-700' },
                        'fuchsia': { bg: 'bg-fuchsia-100', text: 'text-fuchsia-700' },
                        'sky': { bg: 'bg-sky-100', text: 'text-sky-700' },
                        'cyan': { bg: 'bg-cyan-100', text: 'text-cyan-700' },
                        'stone': { bg: 'bg-stone-100', text: 'text-stone-700' },
                        'zinc': { bg: 'bg-zinc-100', text: 'text-zinc-700' },
                        'neutral': { bg: 'bg-neutral-100', text: 'text-neutral-700' }
                        // Th√™m c√°c m√†u kh√°c m√† API badge c·ªßa b·∫°n c√≥ th·ªÉ tr·∫£ v·ªÅ,
                        // v√≠ d·ª•: 'orange', 'lime', 'teal', etc.
                        // v√† ch·ªçn c√°c class Tailwind t∆∞∆°ng ·ª©ng (v√≠ d·ª• bg-orange-100 text-orange-700)
                    };
                    return colorMap[apiColorName.toLowerCase()] || { bg: 'bg-gray-200', text: 'text-gray-800' }; // Fallback
                },
            }
        }
    </script>
</body>

</html>